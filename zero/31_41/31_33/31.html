<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>31</title>
  <style>
    table {
      margin: 20px auto;
      border-collapse: collapse;
      text-align: center;
    }
    th,td {
      padding: 2px 4px;
      border: 1px solid black;

    }

  </style>
</head>
<body>
  <!--  
    <input type="radio" value="华南" id="hua-nan" name="region"> <label for="hua-nan">华南</label>
    <input type="radio" value="华东" id="hua-dong" name="region"> <label for="hua-dong">华东</label>
    <input type="radio" value="华北" id="hua-bei" name="region"> <label for="hua-bei">华北</label>

<label for="region-select">地区</label>
  <select name="region" id="region-select">
    <option value=""></option>
    <option value="华南">华南</option>
    <option value="华东">华东</option>
    <option value="华北">华北</option>
  </select>
  <label for="product-select">商品</label>
  <select name="product" id="product-select">
      <option value=""></option>
    <option value="手机">手机</option>
    <option value="笔记本">笔记本</option>
    <option value="智能音箱">智能音箱</option>
  </select>
-->
  <div id="region-radio-wrapper"></div>
  <div id="product-radio-wrapper"></div>
  <div id="table-wrapper"></div>


<!-- 
  <script>
    var regionRadioWrapper = document.getElementById('region-radio-wrapper');
    var productRadioWraper = document.getElementById('product-radio-wrapper');
    var tableWrapper = document.getElementById('table-wrapper');
    function generateCheckBox(container, value){
      var frag = document.createDocumentFragment();
      for (var i=0; i<value.length; ++i) {
        var input = document.createElement('input');
        var label = document.createElement('label');

        for (j in value[i]){
          input.setAttribute(j, value[i][j]);  
        }

        label.setAttribute('for', value[i]['id']);
        label.innerText = value[i]['value'];
        frag.appendChild(input);
        frag.appendChild(label);
      }
      container.appendChild(frag);
    };
    function checkBoxEventAgent(container) {
      container.addEventListener('change', function(e){
        //e.preventDefault() 这个是阻止默认事件
        //e.stopPropagation(); 这个是阻止事件冒泡

        var checkboxAll = container.querySelector('input[checkbox-type="all"]');
          var checkboxChild = container.querySelectorAll('input[checkbox-type="child"]');
        var checkboxType = e.target.getAttribute('checkbox-type');

        if (checkboxType == 'all') {
          if (e.target.checked) {
            // 全选
            //console.log('全选')
            checkboxChild.forEach(function(item){
              item.checked = true;
            })
          } else {
            // 取消全选
            //console.log('取消全选');
            checkboxChild.forEach(function(item){
              item.checked = false;
            })
          }
        } else if (checkboxType == 'child'){
            var status = 0;
            checkboxChild.forEach(function(item){
              if (item.checked) status++;
            })
            if (status == 0)  e.target.checked = true;
            else if (status> 0 && status < checkboxChild.length ) checkboxAll.checked = false;
            else if (status == checkboxChild.length) checkboxAll.checked = true;
        }
        // 渲染数据
        renderTable( getData( getCheckedValue() ) );
      })
    };
    // 得到被勾选的值
    function getCheckedValue(){
      var region = [];
        var product = [];
        var regionNode = regionRadioWrapper.querySelectorAll('input[checkbox-type="child"]');
        var productNode = productRadioWraper.querySelectorAll('input[checkbox-type="child"]');
        regionNode.forEach(function(item){
          if (item.checked){
            region.push(item.value);
          }
        })
        productNode.forEach(function(item){
          if (item.checked){
            product.push(item.value);
          }
      })
      //console.log([product,region] );
      return [product,region]
    }
    
    // 获取数据
    function getData(checkedVlaue) {
      var data = [];
      // 只有同时选择地区和商品，才得到数据  
      for (var i=0; i<checkedVlaue[0].length; ++i) {
        //console.log(checkedVlaue[0], checkedVlaue[0][i])
        for (var j=0; j < checkedVlaue[1].length;++j){
          for (var k=0; k< sourceData.length; ++k) {
            if (checkedVlaue[0][i] == sourceData[k].product && checkedVlaue[1][j] == sourceData[k].region){
              data.push(sourceData[k]);
            }
          }
        }
      }
      console.log(data);
      return data;
    }
    // 数据渲染 
    function renderTable(data){
      var regionNode = regionRadioWrapper.querySelectorAll('input[checkbox-type="child"]');
      var productNode = productRadioWraper.querySelectorAll('input[checkbox-type="child"]');
      var regionNum = 0;
      var productNum = 0;
      regionNode.forEach(function(item){
        if (item.checked) regionNum++;
      })
      productNode.forEach(function(item){
        if (item.checked) productNum++;
      })
      console.log(regionNum, productNum);
      tableWrapper.innerHTML = '' // 清空节点信息
      if (regionNum > 0 && productNum> 0) {
        if (regionNum == 1 && productNum > regionNum){
        // 地区作为第一列 
        var tableHead = ['地区', '商品','1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
        tableWrapper.appendChild(generatetable(tableHead,data,regionNum,productNum));
        }else {
          // 商品作为第一列
          var tableHead = ['商品', '地区','1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
          var tableBody = [];
          tableWrapper.appendChild(generatetable(tableHead ,data, regionNum, productNum));
        }
      }
    }
    function generatetable(tableHead, tableBody, regionNum,productNum ){
      var tableNode = document.createElement('table'); // 创建节点。
      // 创建表头;
      var tr = document.createElement('tr');
      for (var j=0; j<tableHead.length; ++j) {
        var th = document.createElement('th');
        th.innerText = tableHead[j];
        tr.appendChild(th);
      }
      tableNode.appendChild(tr); // 加入节点

      // 创建表身
      if (regionNum == 1 && productNum > regionNum){
        // 地区作为第一列 
        var tr= document.createElement('tr');
        var td = document.createElement('td');
        td.innerText = tableBody[0].region ;
        td.setAttribute('rowspan', productNum+1); // 跨商品行+1
        tr.appendChild(td);
        tableNode.appendChild(tr);

        for (var i=0; i<tableBody.length; ++i) {
          var tr = document.createElement('tr');
          var td = document.createElement('td');

          td.innerText = tableBody[i].product;
          tr.appendChild(td);
          
          for (var j=0; j<tableBody[i].sale.length; ++j ){
            var td = document.createElement('td');
            td.innerText = tableBody[i].sale[j];
            tr.appendChild(td);
          };
          tableNode.appendChild(tr);
        }
      } else {
         // 商品作为第一列
         console.log(tableBody, regionNum, productNum)
         for (var i=0; i<productNum; ++i) {
           var frag = document.createDocumentFragment();
           var tr = document.createElement('tr');
           var td = document.createElement('td');
           td.innerText = tableBody[i*regionNum].product ;
           td.setAttribute('rowspan', regionNum+1);
           tr.appendChild(td);
          frag.appendChild(tr);

          var t = tableBody.slice(i*regionNum, (i+1)*regionNum);
          console.log(t);
          for (var j=0; j<t.length; ++j) {
            var tr = document.createElement('tr');
            var td = document.createElement('td');

            td.innerText = t[j].region;
            tr.appendChild(td);
            frag.appendChild(tr);

            for (var k=0; k<t[j].sale.length; ++k ){
              var td = document.createElement('td');
              td.innerText = t[j].sale[k];
              tr.appendChild(td);
              frag.appendChild(tr);
            };
          }
          tableNode.appendChild(frag);

         }
      }
      return tableNode;
    }
    // 生成容器中的内容， 即html的内容
    generateCheckBox(regionRadioWrapper,[
      {'id': 'select-all-region', 'type': 'checkbox','checkbox-type': 'all', 'value':'全选' },
      {'id': 'hua-nan', 'type': 'checkbox', 'checkbox-type':'child', 'value': '华南'},
      {'id': 'hua-bei', 'type': 'checkbox', 'checkbox-type':'child', 'value': '华北'},
      {'id': 'hua-dong', 'type': 'checkbox', 'checkbox-type':'child', 'value': '华东'}
    ]);
    generateCheckBox(productRadioWraper, [
      {'id': 'select-all-product', 'type': 'checkbox', 'checkbox-type': 'all', 'value':'全选'},
      {'id': 'mobile-phone','type': 'checkbox', 'checkbox-type': 'child', 'value':'手机'},
      {'id': 'notebook-pc', 'type': 'checkbox', 'checkbox-type': 'child', 'value': '笔记本'},
      {'id': 'speakers', 'type': 'checkbox', 'checkbox-type': 'child', 'value': '智能音箱'}
    ]);

    // 为checkbox 进行事件代理
    checkBoxEventAgent(regionRadioWrapper);
    checkBoxEventAgent(productRadioWraper);

  </script>
-->
  <script src="ife31data.js"></script>
  <script src="./js/checkbox.js"></script>
  <script src="./js/getdata.js"></script>
  <script src="./js/table.js"></script>
  <script src="./js/apps.js"></script>
</body>
</html>